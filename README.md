### 分公司业务效能分析系统（Excel 数据版）

一个面向“分公司/子公司”的业务投入效能自动化分析脚本：将符合命名规则的 Excel 拖进数据目录，直接运行即可完成数据整合、KPI 计算、健康度评分并输出可视化报告（含柱状图）。若目录已有数据，程序会先自动做时间戳备份，再分析原数据。

---

## 1. 这个代码能做什么
- 自动读取多家公司、多月份的两类报表文件（财务/业务），并完成清洗与整合
- 计算核心 KPI：营收月度增长率、CAC、留存率、毛利率、ARPU、LTV、LTV/CAC 比率
- 基于可配置阈值输出健康度评分与评级（A/B/C/D）
- 生成 Excel 报告：
  - 汇总仪表盘：展示各公司最新 KPI 表格与两张柱状图（LTV/CAC、营业收入）
  - 明细数据：输出按公司×月份的全量明细与 KPI
- 自动数据备份：检测到数据目录已有文件时，先复制到 `报告目录/data_backup/<时间戳>/` 后再分析

## 2. 适用场景
- 集团型公司希望按月汇总各分子公司经营情况，并快速评估投入产出
- 只需“拖拽 Excel 到固定文件夹 → 运行脚本 → 打开报告”
- 支持真实数据；若目录为空也可一键生成“真实感模拟数据”以便演示

## 3. 目录与配置
默认配置位于 `main.py` 的 `config`：
```python
config = {
    'data_folder': r'D:\分公司月度数据',      # 放 Excel 的目录
    'report_folder': r'D:\效能分析报告',     # 报告与备份输出目录
    'score_rules': {
        '营收月度增长率': {'高': 0.15, '中': 0.05},
        'LTV/CAC 比率': {'高': 3, '中': 1},
    }
}
```

## 4. 数据文件命名与列规范
在 `data_folder` 里放两类文件（两列结构）：

1) 财务：`公司名_财务_YYYYMM.xlsx`
- 列：`科目`、`金额`
- 科目值允许：`营业收入`、`营业成本`、`市场费用`、`研发费用`、`管理费用`

2) 业务：`公司名_业务_YYYYMM.xlsx`
- 列：`指标`、`数值`
- 指标值允许：`月初用户数`、`月末用户数`、`新增用户数`、`总订单数`、`付费用户数`

注意：
- 同一公司同一月份如存在重复，程序保留“最后一条”（去重）
- 数值列应为可解析的数字；列名需与上述中文完全一致

## 5. KPI 口径（重点）
- 营收月度增长率：`(当月营收 - 上月营收) / 上月营收`
- CAC（获客成本）：`市场费用 / 估计的投放新增`
  - 估计投放新增 = `新增用户数 - 自然新增估计`，自然新增按月初规模的 1%（并限幅）估计
- 留存率：`(月末用户数 - 新增用户数) / 上月月末用户数`（限幅 0.55~0.98）
- 毛利率：`(营业收入 - 营业成本) / 营业收入`（限幅 0.20~0.85）
- ARPU：`营业收入 / 付费用户数`
- LTV（估算）：`ARPU * 毛利率 * (1 / max(0.05, 1.1 - 留存率))`（宽护栏）
- LTV/CAC 比率：`LTV / CAC`（宽护栏）

## 6. 运行步骤
### 方式A：使用你的真实数据
1. 将 Excel 放入 `data_folder`（默认：`D:\分公司月度数据`）
2. 运行：
```bash
python main.py
```
3. 程序会：
   - 先备份数据到 `report_folder/data_backup/<时间戳>/`
   - 完成整合、KPI、评分并在 `report_folder` 输出 `分公司效能分析报告_YYYYMMDD.xlsx`

### 方式B：没有现成数据（演示用）
- 直接运行 `python main.py`。若数据目录为空，脚本会自动生成“真实感模拟数据”后再分析。

## 7. 报告说明
- 工作表 `汇总仪表盘`：
  - 最新一期公司维度 KPI 表格（使用数值单元格并设置 number_format）
  - 柱状图：各公司 LTV/CAC 比率、各公司营业收入
- 工作表 `明细数据`：
  - 所有公司 × 月份的原始整合与 KPI 计算结果

## 8. 依赖环境
- Python 3.9+
- `pandas`、`numpy`、`openpyxl`

安装示例：
```bash
pip install pandas numpy openpyxl
```

## 9. 常见问题
- 图表不对/空白：
  - 请确认未手动把数字改成字符串；重跑脚本会覆盖生成正确图表
- 比率接近：
  - 若你的真实数据差异较小，LTV/CAC 会自然接近。可从留存、毛利、价格、付费转换、市场效率等维度拉开差异
- 只分析我拖进去的文件：
  - 只要数据目录已有符合命名的 `.xlsx`，脚本会跳过模拟生成，先备份再分析

## 10. 免责声明
- 示例生成的数据仅为演示用途，不代表真实业务；使用真实数据时请遵循公司数据合规要求。

用户手册：集团分公司业务投入效能自动化分析系统
1. 概述
本系统是一个基于Python的自动化分析脚本，旨在帮助集团总部快速评估各分公司的业务投入效能。系统自动读取月度数据，计算关键绩效指标（KPI），生成健康度评分，并最终产出一份包含图表和明细数据的Excel报告。

2. 运行环境
操作系统: Windows, macOS, Linux

Python版本: 3.7+

所需库:

pandas：用于数据处理和分析。

openpyxl：用于读写Excel文件。

matplotlib：用于生成图表。

安装方法：
打开终端或命令提示符，执行以下命令安装所需库：

pip install pandas openpyxl matplotlib

3. 使用说明
步骤 1：准备数据文件
将各分公司每月提交的标准格式的Excel文件（财务数据和业务数据）放入指定的数据文件夹。

文件命名规范：文件名前半部分为分公司名称，后半部分为日期，中间用下划线 _ 连接。

示例：公司A_财务_202310.xlsx 和 公司A_业务_202310.xlsx

财务数据文件中必须包含“营业收入”、“市场费用”等科目。

业务数据文件中必须包含“新增用户数”、“付费用户数”等指标。

请确保所有Excel文件中的工作表结构和列名（如“科目”、“指标”、“金额”）都是统一的。

步骤 2：配置脚本
打开 main.py 文件。

在 main() 函数中找到 config 字典，修改以下两个关键路径：

data_folder: 将其设置为您的数据文件夹的绝对路径（例如：D:\分公司月度数据）。

report_folder: 将其设置为您希望保存报告的文件夹的绝对路径。

步骤 3：运行程序
打开终端或命令提示符，导航到 main.py 文件所在的目录。

执行以下命令运行脚本：

python main.py

脚本运行过程中，会打印出当前执行的步骤。如果一切正常，您将在报告文件夹中找到一个以日期命名的Excel文件。

4. 交付物说明
分公司效能分析报告_YYYYMMDD.xlsx：

汇总仪表盘 Sheet：包含柱状图，直观展示各分公司的LTV/CAC比率和健康度综合得分对比。

明细数据 Sheet：存放所有原始数据以及计算出的所有KPI和评分。

5. 故障排除
文件找不到：请检查 config 中的 data_folder 路径是否正确，以及数据文件名是否符合规范。

程序崩溃：可能是Excel文件格式不正确或缺少必要的列。请检查数据文件是否为标准模板。

KPI值为NaN或Inf：通常是由于缺少上月数据（例如计算增长率和留存率）或数据中存在0值（例如新增用户数为0时计算CAC）。
