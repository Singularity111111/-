# 数据分析日报自动生成脚本 - 使用说明

## 一、脚本简介

本Python脚本 (`process_reports.py`) 旨在完全自动化地处理日常运营数据，并一键生成三份关键的数据分析日报：

1.  **《产品日报》** (`产品日报_YYYY-MM-DD.csv`)
2.  **《部门总汇表》** (`部门总汇表_YYYY-MM-DD.csv`)
3.  **《渠道总汇表》** (`渠道总汇表_YYYY-MM-DD.csv`)

脚本会自动读取5个指定的Excel源文件，执行复杂的业务逻辑计算（如多日LTV、成本、盈余率、部门数据聚合等），并最终输出为格式清晰、可直接使用的CSV报表。

## 二、核心业务逻辑亮点

### 1. 货币单位 (美元/u)
**所有输出报表中的金额单位均为美元 (USD)，即 u。** 脚本内置了自动汇率换算功能，会根据脚本顶部配置的 `EXCHANGE_RATE`（默认为 281）将原始文件中的卢比 (PKR) 金额转换为美元。

### 2. LTV（生命周期价值）归因
本脚本采用了精确的LTV归因逻辑：
* **《产品日报》的LTV**: 使用 **`Book2.xlsx` (产品数据源)** 计算，代表产品**整体**的生命周期价值。
* **《部门总汇表》的LTV**: 使用 **`Book1.xlsx` (渠道数据源)** 进行计算。脚本会为**每个部门**筛选出其专属的用户数据，并**独立计算**其LTV-7/15/30天，确保了LTV的归因准确性。

## 三、运行前准备 (首次使用)

### 1. 安装必要的Python库
在首次运行脚本前，请确保您的Python环境中已安装 `pandas` 和 `openpyxl` 库。如果尚未安装，请打开命令行工具（如CMD或PowerShell）并运行以下命令：
```bash
pip install pandas openpyxl
```

### 2. 文件与目录结构
为了让脚本能顺利找到所有数据源，请务必将**所有5个Excel源文件**与`process_reports.py`脚本文件存放在**同一个文件夹**下。推荐的目录结构如下所示：

```
/数据报表自动化/            <-- 任意新建一个文件夹
│
├── process_reports.py     # 这是我们的Python脚本
│
├── Book1.xlsx             # 渠道数据源 (部门LTV计算核心)
├── Book2.xlsx             # 产品数据源 (产品LTV计算核心)
├── Book3.xlsx             # 部门映射表
├── Book4.xlsx             # 复充率数据
└── Book5.xlsx             # 消耗数据
```

## 四、如何使用 (日常操作)

### 1. 配置报表日期（可选）
用任何文本编辑器（如记事本、VS Code等）打开 `process_reports.py` 脚本，在顶部的“配置区域”找到 `REPORT_DATE` 变量：
```python
# 报表日期（设为None则自动使用最新日期）
REPORT_DATE = '2025-08-29' # 例如: '2025-08-29'
```
* **生成指定日期的报表**：如上所示，直接修改 `'2025-08-29'` 为你想要的日期（必须使用 `YYYY-MM-DD` 格式）。
* **自动生成最新日期的报表**：将此行修改为 `REPORT_DATE = None`。脚本会自动从 `Book1.xlsx` 中查找并使用最新的日期作为报表日期。

### 2. 运行脚本
1.  打开命令行工具（CMD, PowerShell, Terminal等）。
2.  使用 `cd` 命令进入您存放脚本和Excel文件的文件夹。例如：
    ```bash
    cd C:\Users\你的用户名\Desktop\数据报表自动化
    ```
3.  运行以下命令执行脚本：
    ```bash
    python process_reports.py
    ```
4.  脚本会开始执行，并在屏幕上打印出每一步的处理日志。
5.  执行完毕后，三份新鲜出炉的CSV报表将自动保存在当前文件夹中。

## 五、常见问题排查 (Troubleshooting)

1.  **报错：`Permission denied: 'Book1.xlsx'`**
    * **原因**：文件被其他程序（99%的情况是Excel）占用了。
    * **解决方法**：**关闭所有正在打开的Excel文件**，然后重新运行脚本。

2.  **报错：`KeyError: '某个列名'`**
    * **原因**：脚本在Excel文件中找不到指定的列名。这通常是由于列名有**肉眼难以发现的空格**或存在**错别字**。
    * **解决方法**：本脚本已内置**自动清理列名前后空格**和**强制转换核心数据列为数字**的功能，能避免绝大多数此类问题。如果依然报错，请仔细核对您Excel文件中的列名是否与业务逻辑要求一致。

3.  **LTV数值与预期不符**
    * **原因**：LTV的计算结果完全取决于 `Book1.xlsx` 和 `Book2.xlsx` 中的原始数据。
    * **解决方法**：脚本在运行时会打印出用于计算LTV的**详细过程**，包括**日期范围**、**“充减提”总和**和**“首存人数”总和**。您可以根据这些日志，手动核对相应Excel文件中对应时间段的数据，以找出差异来源。
